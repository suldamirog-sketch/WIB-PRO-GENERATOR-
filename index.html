<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIB Pro Generator - Verbesserte Version</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@700&family=Russo+One&family=Teko:wght@700&family=Anton&family=Black+Ops+One&family=Permanent+Marker&family=Righteous&family=Staatliches&family=Passion+One:wght@700&family=Montserrat:wght@900&family=Impact&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 42px;
            background: linear-gradient(45deg, #ff0844, #ffb199);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 20px;
        }

        .controls-panel {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 15px;
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }

        .controls-panel::-webkit-scrollbar {
            width: 10px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: #0a0a0a;
            border-radius: 10px;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: #ff0844;
            border-radius: 10px;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid #2a2a2a;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #ff0844;
            margin-bottom: 18px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .control-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #ff0844;
            background: #333;
        }

        input[type="color"] {
            width: 100%;
            height: 50px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            border: 2px dashed #3a3a3a;
            border-radius: 8px;
            cursor: pointer;
            color: #999;
            font-size: 13px;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #3a3a3a;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #ff0844;
            border-radius: 50%;
            cursor: pointer;
        }

        .range-value {
            display: inline-block;
            float: right;
            color: #ff0844;
            font-weight: 700;
            font-size: 13px;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .preset-btn {
            padding: 12px;
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            border-color: #ff0844;
            background: #333;
            transform: translateY(-2px);
        }

        .action-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff0844, #ff5e3a);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 8, 68, 0.5);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border: 2px solid #3a3a3a;
        }

        .canvas-container {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 15px;
            position: relative;
        }

        #renderCanvas {
            width: 100%;
            max-width: 1280px;
            height: auto;
            display: block;
            border-radius: 12px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.9);
        }

        .audio-controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            align-items: center;
        }

        .play-btn {
            width: 55px;
            height: 55px;
            background: #ff0844;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .play-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 5px 25px rgba(255, 8, 68, 0.6);
        }

        .audio-time {
            flex: 1;
            background: #2a2a2a;
            padding: 12px 18px;
            border-radius: 10px;
            font-family: monospace;
            color: #ff0844;
            font-size: 16px;
            font-weight: 700;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            padding: 15px 25px;
            border-radius: 10px;
            border-left: 4px solid #ff0844;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        .two-col-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .color-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .color-row input[type="color"] {
            flex: 1;
            height: 50px;
        }

        .remove-btn {
            padding: 12px;
            background: #ff0844;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

        .remove-btn:hover {
            background: #cc0035;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ WIB PRO GENERATOR - VERBESSERT</h1>
        
        <div class="main-grid">
            <!-- Controls Panel -->
            <div class="controls-panel">
                
                <!-- Background Image Section -->
                <div class="section">
                    <div class="section-title">üñºÔ∏è Hintergrundbild</div>
                    <div class="control-group">
                        <label>Hintergrundbild hochladen</label>
                        <input type="file" id="backgroundImage" accept="image/*">
                    </div>
                    <div class="control-group">
                        <label>Helligkeit <span class="range-value" id="bgBrightnessValue">100%</span></label>
                        <input type="range" id="bgBrightness" min="0" max="200" value="100">
                    </div>
                    <div class="control-group">
                        <label>Unsch√§rfe <span class="range-value" id="bgBlurValue">0px</span></label>
                        <input type="range" id="bgBlur" min="0" max="30" value="0">
                    </div>
                    <div class="control-group">
                        <label>Skalierung <span class="range-value" id="bgScaleValue">100%</span></label>
                        <input type="range" id="bgScale" min="50" max="200" value="100">
                    </div>
                    <div class="control-group">
                        <label>Position X <span class="range-value" id="bgPosXValue">50%</span></label>
                        <input type="range" id="bgPosX" min="0" max="100" value="50">
                    </div>
                    <div class="control-group">
                        <label>Position Y <span class="range-value" id="bgPosYValue">50%</span></label>
                        <input type="range" id="bgPosY" min="0" max="100" value="50">
                    </div>
                    <div class="control-group">
                        <label>Abdunklung (Overlay) <span class="range-value" id="bgOverlayValue">30%</span></label>
                        <input type="range" id="bgOverlay" min="0" max="100" value="30">
                    </div>
                </div>

                <!-- Text 1 Section -->
                <div class="section">
                    <div class="section-title">‚úèÔ∏è Text 1 (Oben)</div>
                    <div class="control-group">
                        <label>Text</label>
                        <input type="text" id="text1" value="DRILL" maxlength="50">
                    </div>
                    <div class="control-group">
                        <label>Schriftart</label>
                        <select id="font1">
                            <option value="Bebas Neue">Bebas Neue</option>
                            <option value="Anton">Anton</option>
                            <option value="Oswald">Oswald</option>
                            <option value="Russo One">Russo One</option>
                            <option value="Black Ops One">Black Ops One</option>
                            <option value="Permanent Marker">Permanent Marker</option>
                            <option value="Righteous">Righteous</option>
                            <option value="Staatliches">Staatliches</option>
                            <option value="Passion One">Passion One</option>
                            <option value="Teko">Teko</option>
                            <option value="Montserrat">Montserrat Black</option>
                            <option value="Impact">Impact</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Textfarbe</label>
                        <input type="color" id="textColor1" value="#ffffff">
                    </div>
                    <div class="control-group">
                        <label>Textgr√∂√üe <span class="range-value" id="fontSize1Value">120px</span></label>
                        <input type="range" id="fontSize1" min="50" max="300" value="120">
                    </div>
                    <div class="control-group">
                        <label>Position Y <span class="range-value" id="textPosY1Value">200</span></label>
                        <input type="range" id="textPosY1" min="50" max="500" value="200">
                    </div>
                    <div class="control-group">
                        <label>Buchstabenabstand <span class="range-value" id="letterSpacing1Value">20px</span></label>
                        <input type="range" id="letterSpacing1" min="0" max="50" value="20">
                    </div>
                    <div class="control-group">
                        <label>Kontur Dicke <span class="range-value" id="stroke1Value">6px</span></label>
                        <input type="range" id="stroke1" min="0" max="20" value="6">
                    </div>
                    <div class="control-group">
                        <label>Konturfarbe</label>
                        <input type="color" id="strokeColor1" value="#000000">
                    </div>
                    <div class="control-group">
                        <label>Transparenz <span class="range-value" id="opacity1Value">100%</span></label>
                        <input type="range" id="opacity1" min="0" max="100" value="100">
                    </div>
                    <div class="control-group">
                        <label>Rotation <span class="range-value" id="rotation1Value">0¬∞</span></label>
                        <input type="range" id="rotation1" min="-45" max="45" value="0">
                    </div>
                </div>

                <!-- Text 2 Section -->
                <div class="section">
                    <div class="section-title">‚úèÔ∏è Text 2 (Unten)</div>
                    <div class="control-group">
                        <label>Text</label>
                        <input type="text" id="text2" value="BALKAN" maxlength="50">
                    </div>
                    <div class="control-group">
                        <label>Schriftart</label>
                        <select id="font2">
                            <option value="Bebas Neue">Bebas Neue</option>
                            <option value="Anton">Anton</option>
                            <option value="Oswald">Oswald</option>
                            <option value="Russo One">Russo One</option>
                            <option value="Black Ops One">Black Ops One</option>
                            <option value="Permanent Marker">Permanent Marker</option>
                            <option value="Righteous">Righteous</option>
                            <option value="Staatliches">Staatliches</option>
                            <option value="Passion One">Passion One</option>
                            <option value="Teko">Teko</option>
                            <option value="Montserrat">Montserrat Black</option>
                            <option value="Impact">Impact</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Textfarbe</label>
                        <input type="color" id="textColor2" value="#ffffff">
                    </div>
                    <div class="control-group">
                        <label>Textgr√∂√üe <span class="range-value" id="fontSize2Value">120px</span></label>
                        <input type="range" id="fontSize2" min="50" max="300" value="120">
                    </div>
                    <div class="control-group">
                        <label>Position Y <span class="range-value" id="textPosY2Value">520</span></label>
                        <input type="range" id="textPosY2" min="400" max="650" value="520">
                    </div>
                    <div class="control-group">
                        <label>Buchstabenabstand <span class="range-value" id="letterSpacing2Value">20px</span></label>
                        <input type="range" id="letterSpacing2" min="0" max="50" value="20">
                    </div>
                    <div class="control-group">
                        <label>Kontur Dicke <span class="range-value" id="stroke2Value">6px</span></label>
                        <input type="range" id="stroke2" min="0" max="20" value="6">
                    </div>
                    <div class="control-group">
                        <label>Konturfarbe</label>
                        <input type="color" id="strokeColor2" value="#000000">
                    </div>
                    <div class="control-group">
                        <label>Transparenz <span class="range-value" id="opacity2Value">100%</span></label>
                        <input type="range" id="opacity2" min="0" max="100" value="100">
                    </div>
                    <div class="control-group">
                        <label>Rotation <span class="range-value" id="rotation2Value">0¬∞</span></label>
                        <input type="range" id="rotation2" min="-45" max="45" value="0">
                    </div>
                </div>

                <!-- Badge Section -->
                <div class="section">
                    <div class="section-title">üè∑Ô∏è Badge / Label</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showBadge" checked>
                        <label for="showBadge">Badge anzeigen</label>
                    </div>
                    <div class="control-group">
                        <label>Badge Text</label>
                        <input type="text" id="badge" value="FREE" maxlength="20">
                    </div>
                    <div class="control-group">
                        <label>Badge Farbe</label>
                        <input type="color" id="badgeColor" value="#ff0844">
                    </div>
                    <div class="control-group">
                        <label>Badge Position X <span class="range-value" id="badgePosXValue">100</span></label>
                        <input type="range" id="badgePosX" min="50" max="300" value="100">
                    </div>
                    <div class="control-group">
                        <label>Badge Position Y <span class="range-value" id="badgePosYValue">100</span></label>
                        <input type="range" id="badgePosY" min="50" max="300" value="100">
                    </div>
                    <div class="control-group">
                        <label>Badge Gr√∂√üe <span class="range-value" id="badgeSizeValue">1.0</span></label>
                        <input type="range" id="badgeSize" min="0.5" max="2" step="0.1" value="1.0">
                    </div>
                    <div class="control-group">
                        <label>Badge Rotation <span class="range-value" id="badgeRotValue">-15¬∞</span></label>
                        <input type="range" id="badgeRot" min="-45" max="45" value="-15">
                    </div>
                </div>

                <!-- Logo Section -->
                <div class="section">
                    <div class="section-title">üé® Logo (Transparent)</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showLogo">
                        <label for="showLogo">Logo anzeigen</label>
                    </div>
                    <div class="control-group">
                        <label>Logo hochladen (PNG transparent empfohlen)</label>
                        <input type="file" id="logoImage" accept="image/*">
                    </div>
                    <div class="control-group">
                        <label>Logo Gr√∂√üe <span class="range-value" id="logoSizeValue">150px</span></label>
                        <input type="range" id="logoSize" min="50" max="500" value="150">
                    </div>
                    <div class="control-group">
                        <label>Logo Position X <span class="range-value" id="logoPosXValue">640</span></label>
                        <input type="range" id="logoPosX" min="0" max="1280" value="640">
                    </div>
                    <div class="control-group">
                        <label>Logo Position Y <span class="range-value" id="logoPosYValue">360</span></label>
                        <input type="range" id="logoPosY" min="0" max="720" value="360">
                    </div>
                    <div class="control-group">
                        <label>Logo Transparenz <span class="range-value" id="logoOpacityValue">80%</span></label>
                        <input type="range" id="logoOpacity" min="0" max="100" value="80">
                    </div>
                    <div class="control-group">
                        <label>Logo Rotation <span class="range-value" id="logoRotValue">0¬∞</span></label>
                        <input type="range" id="logoRot" min="-180" max="180" value="0">
                    </div>
                </div>

                <!-- BPM & Info Section -->
                <div class="section">
                    <div class="section-title">‚ÑπÔ∏è Beat Info</div>
                    <div class="control-group">
                        <label>BPM</label>
                        <input type="number" id="bpm" value="140" min="60" max="200">
                    </div>
                    <div class="control-group">
                        <label>Zusatztext (unten rechts)</label>
                        <input type="text" id="infoText" value="Prod. by WIB" maxlength="50">
                    </div>
                    <div class="control-group">
                        <label>Zusatztext Gr√∂√üe <span class="range-value" id="infoSizeValue">24px</span></label>
                        <input type="range" id="infoSize" min="12" max="50" value="24">
                    </div>
                    <div class="control-group">
                        <label>Zusatztext Farbe</label>
                        <input type="color" id="infoColor" value="#ffffff">
                    </div>
                </div>

                <!-- Animation Section -->
                <div class="section">
                    <div class="section-title">üé¨ Animation</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableReactive">
                        <label for="enableReactive">Audio-reaktive Animation</label>
                    </div>
                    <div class="control-group">
                        <label>Puls-St√§rke <span class="range-value" id="pulseValue">20</span></label>
                        <input type="range" id="pulseStrength" min="0" max="50" value="20">
                    </div>
                </div>

                <!-- Audio Section -->
                <div class="section">
                    <div class="section-title">üéµ Audio</div>
                    <div class="control-group">
                        <label>Audio hochladen (MP3, WAV)</label>
                        <input type="file" id="audioFile" accept="audio/*">
                    </div>
                </div>

                <!-- Presets -->
                <div class="section">
                    <div class="section-title">üé® Vorlagen</div>
                    <div class="preset-grid">
                        <button class="preset-btn" onclick="applyPreset('drill')">Drill</button>
                        <button class="preset-btn" onclick="applyPreset('trap')">Trap</button>
                        <button class="preset-btn" onclick="applyPreset('melodic')">Melodic</button>
                        <button class="preset-btn" onclick="applyPreset('aggressive')">Hard</button>
                        <button class="preset-btn" onclick="applyPreset('balkan')">Balkan</button>
                        <button class="preset-btn" onclick="applyPreset('dark')">Dark</button>
                    </div>
                </div>

                <!-- Export Actions -->
                <div class="section">
                    <button class="action-btn" onclick="downloadImage()">üíæ Als PNG speichern</button>
                    <button class="action-btn secondary" id="recordBtn" onclick="recordVideo()">üé¨ Video aufnehmen (Echtzeit)</button>
                    <p style="font-size: 11px; color: #999; margin-top: 8px; line-height: 1.4;">
                        üí° Klick ‚Üí Audio spielt ab ‚Üí Wird aufgenommen ‚Üí Automatischer Download<br>
                        ‚ö° Dauert nur so lange wie das Audio!
                    </p>
                </div>
            </div>

            <!-- Canvas Section -->
            <div class="canvas-container">
                <canvas id="renderCanvas" width="1280" height="720"></canvas>
                
                <div class="audio-controls">
                    <button class="play-btn" id="playBtn" onclick="toggleAudio()">‚ñ∂</button>
                    <div class="audio-time" id="audioTime">0:00 / 0:00</div>
                </div>

                <div class="status-message" id="statusMsg"></div>
            </div>
        </div>
    </div>

    <script>
        // Canvas Setup
        const canvas = document.getElementById('renderCanvas');
        const ctx = canvas.getContext('2d');

        // State
        const state = {
            // Background
            backgroundImage: null,
            bgBrightness: 100,
            bgBlur: 0,
            bgScale: 100,
            bgPosX: 50,
            bgPosY: 50,
            bgOverlay: 30,
            
            // Text 1
            text1: 'DRILL',
            font1: 'Bebas Neue',
            textColor1: '#ffffff',
            fontSize1: 120,
            textPosY1: 200,
            letterSpacing1: 20,
            stroke1: 6,
            strokeColor1: '#000000',
            opacity1: 100,
            rotation1: 0,
            
            // Text 2
            text2: 'BALKAN',
            font2: 'Bebas Neue',
            textColor2: '#ffffff',
            fontSize2: 120,
            textPosY2: 520,
            letterSpacing2: 20,
            stroke2: 6,
            strokeColor2: '#000000',
            opacity2: 100,
            rotation2: 0,
            
            // Badge
            showBadge: true,
            badge: 'FREE',
            badgeColor: '#ff0844',
            badgePosX: 100,
            badgePosY: 100,
            badgeSize: 1.0,
            badgeRot: -15,
            
            // Logo
            showLogo: false,
            logoImage: null,
            logoSize: 150,
            logoPosX: 640,
            logoPosY: 360,
            logoOpacity: 80,
            logoRot: 0,
            
            // Info
            bpm: 140,
            infoText: 'Prod. by WIB',
            infoSize: 24,
            infoColor: '#ffffff',
            
            // Animation
            enableReactive: false,
            pulseStrength: 20
        };

        // Audio
        const audioElement = new Audio();
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        let audioSource = null;
        let isPlaying = false;
        let animationId = null;

        // Event Listeners
        document.getElementById('backgroundImage').addEventListener('change', handleBackgroundUpload);
        document.getElementById('logoImage').addEventListener('change', handleLogoUpload);
        document.getElementById('audioFile').addEventListener('change', handleAudioUpload);

        // Background controls
        document.getElementById('bgBrightness').addEventListener('input', (e) => {
            state.bgBrightness = parseInt(e.target.value);
            document.getElementById('bgBrightnessValue').textContent = state.bgBrightness + '%';
            render();
        });
        document.getElementById('bgBlur').addEventListener('input', (e) => {
            state.bgBlur = parseInt(e.target.value);
            document.getElementById('bgBlurValue').textContent = state.bgBlur + 'px';
            render();
        });
        document.getElementById('bgScale').addEventListener('input', (e) => {
            state.bgScale = parseInt(e.target.value);
            document.getElementById('bgScaleValue').textContent = state.bgScale + '%';
            render();
        });
        document.getElementById('bgPosX').addEventListener('input', (e) => {
            state.bgPosX = parseInt(e.target.value);
            document.getElementById('bgPosXValue').textContent = state.bgPosX + '%';
            render();
        });
        document.getElementById('bgPosY').addEventListener('input', (e) => {
            state.bgPosY = parseInt(e.target.value);
            document.getElementById('bgPosYValue').textContent = state.bgPosY + '%';
            render();
        });
        document.getElementById('bgOverlay').addEventListener('input', (e) => {
            state.bgOverlay = parseInt(e.target.value);
            document.getElementById('bgOverlayValue').textContent = state.bgOverlay + '%';
            render();
        });

        // Text 1 controls
        document.getElementById('text1').addEventListener('input', (e) => {
            state.text1 = e.target.value.toUpperCase();
            render();
        });
        document.getElementById('font1').addEventListener('change', (e) => {
            state.font1 = e.target.value;
            render();
        });
        document.getElementById('textColor1').addEventListener('input', (e) => {
            state.textColor1 = e.target.value;
            render();
        });
        document.getElementById('fontSize1').addEventListener('input', (e) => {
            state.fontSize1 = parseInt(e.target.value);
            document.getElementById('fontSize1Value').textContent = state.fontSize1 + 'px';
            render();
        });
        document.getElementById('textPosY1').addEventListener('input', (e) => {
            state.textPosY1 = parseInt(e.target.value);
            document.getElementById('textPosY1Value').textContent = state.textPosY1;
            render();
        });
        document.getElementById('letterSpacing1').addEventListener('input', (e) => {
            state.letterSpacing1 = parseInt(e.target.value);
            document.getElementById('letterSpacing1Value').textContent = state.letterSpacing1 + 'px';
            render();
        });
        document.getElementById('stroke1').addEventListener('input', (e) => {
            state.stroke1 = parseInt(e.target.value);
            document.getElementById('stroke1Value').textContent = state.stroke1 + 'px';
            render();
        });
        document.getElementById('strokeColor1').addEventListener('input', (e) => {
            state.strokeColor1 = e.target.value;
            render();
        });
        document.getElementById('opacity1').addEventListener('input', (e) => {
            state.opacity1 = parseInt(e.target.value);
            document.getElementById('opacity1Value').textContent = state.opacity1 + '%';
            render();
        });
        document.getElementById('rotation1').addEventListener('input', (e) => {
            state.rotation1 = parseInt(e.target.value);
            document.getElementById('rotation1Value').textContent = state.rotation1 + '¬∞';
            render();
        });

        // Text 2 controls
        document.getElementById('text2').addEventListener('input', (e) => {
            state.text2 = e.target.value.toUpperCase();
            render();
        });
        document.getElementById('font2').addEventListener('change', (e) => {
            state.font2 = e.target.value;
            render();
        });
        document.getElementById('textColor2').addEventListener('input', (e) => {
            state.textColor2 = e.target.value;
            render();
        });
        document.getElementById('fontSize2').addEventListener('input', (e) => {
            state.fontSize2 = parseInt(e.target.value);
            document.getElementById('fontSize2Value').textContent = state.fontSize2 + 'px';
            render();
        });
        document.getElementById('textPosY2').addEventListener('input', (e) => {
            state.textPosY2 = parseInt(e.target.value);
            document.getElementById('textPosY2Value').textContent = state.textPosY2;
            render();
        });
        document.getElementById('letterSpacing2').addEventListener('input', (e) => {
            state.letterSpacing2 = parseInt(e.target.value);
            document.getElementById('letterSpacing2Value').textContent = state.letterSpacing2 + 'px';
            render();
        });
        document.getElementById('stroke2').addEventListener('input', (e) => {
            state.stroke2 = parseInt(e.target.value);
            document.getElementById('stroke2Value').textContent = state.stroke2 + 'px';
            render();
        });
        document.getElementById('strokeColor2').addEventListener('input', (e) => {
            state.strokeColor2 = e.target.value;
            render();
        });
        document.getElementById('opacity2').addEventListener('input', (e) => {
            state.opacity2 = parseInt(e.target.value);
            document.getElementById('opacity2Value').textContent = state.opacity2 + '%';
            render();
        });
        document.getElementById('rotation2').addEventListener('input', (e) => {
            state.rotation2 = parseInt(e.target.value);
            document.getElementById('rotation2Value').textContent = state.rotation2 + '¬∞';
            render();
        });

        // Badge controls
        document.getElementById('showBadge').addEventListener('change', (e) => {
            state.showBadge = e.target.checked;
            render();
        });
        document.getElementById('badge').addEventListener('input', (e) => {
            state.badge = e.target.value.toUpperCase();
            render();
        });
        document.getElementById('badgeColor').addEventListener('input', (e) => {
            state.badgeColor = e.target.value;
            render();
        });
        document.getElementById('badgePosX').addEventListener('input', (e) => {
            state.badgePosX = parseInt(e.target.value);
            document.getElementById('badgePosXValue').textContent = state.badgePosX;
            render();
        });
        document.getElementById('badgePosY').addEventListener('input', (e) => {
            state.badgePosY = parseInt(e.target.value);
            document.getElementById('badgePosYValue').textContent = state.badgePosY;
            render();
        });
        document.getElementById('badgeSize').addEventListener('input', (e) => {
            state.badgeSize = parseFloat(e.target.value);
            document.getElementById('badgeSizeValue').textContent = state.badgeSize.toFixed(1);
            render();
        });
        document.getElementById('badgeRot').addEventListener('input', (e) => {
            state.badgeRot = parseInt(e.target.value);
            document.getElementById('badgeRotValue').textContent = state.badgeRot + '¬∞';
            render();
        });

        // Logo controls
        document.getElementById('showLogo').addEventListener('change', (e) => {
            state.showLogo = e.target.checked;
            render();
        });
        document.getElementById('logoSize').addEventListener('input', (e) => {
            state.logoSize = parseInt(e.target.value);
            document.getElementById('logoSizeValue').textContent = state.logoSize + 'px';
            render();
        });
        document.getElementById('logoPosX').addEventListener('input', (e) => {
            state.logoPosX = parseInt(e.target.value);
            document.getElementById('logoPosXValue').textContent = state.logoPosX;
            render();
        });
        document.getElementById('logoPosY').addEventListener('input', (e) => {
            state.logoPosY = parseInt(e.target.value);
            document.getElementById('logoPosYValue').textContent = state.logoPosY;
            render();
        });
        document.getElementById('logoOpacity').addEventListener('input', (e) => {
            state.logoOpacity = parseInt(e.target.value);
            document.getElementById('logoOpacityValue').textContent = state.logoOpacity + '%';
            render();
        });
        document.getElementById('logoRot').addEventListener('input', (e) => {
            state.logoRot = parseInt(e.target.value);
            document.getElementById('logoRotValue').textContent = state.logoRot + '¬∞';
            render();
        });

        // Info controls
        document.getElementById('bpm').addEventListener('input', (e) => {
            state.bpm = parseInt(e.target.value);
            render();
        });
        document.getElementById('infoText').addEventListener('input', (e) => {
            state.infoText = e.target.value;
            render();
        });
        document.getElementById('infoSize').addEventListener('input', (e) => {
            state.infoSize = parseInt(e.target.value);
            document.getElementById('infoSizeValue').textContent = state.infoSize + 'px';
            render();
        });
        document.getElementById('infoColor').addEventListener('input', (e) => {
            state.infoColor = e.target.value;
            render();
        });

        // Animation controls
        document.getElementById('enableReactive').addEventListener('change', (e) => {
            state.enableReactive = e.target.checked;
            if (state.enableReactive && isPlaying) {
                render();
            }
        });
        document.getElementById('pulseStrength').addEventListener('input', (e) => {
            state.pulseStrength = parseInt(e.target.value);
            document.getElementById('pulseValue').textContent = state.pulseStrength;
        });

        // File handlers
        function handleBackgroundUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    state.backgroundImage = img;
                    render();
                    showStatus('‚úÖ Hintergrundbild geladen!');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    state.logoImage = img;
                    state.showLogo = true;
                    document.getElementById('showLogo').checked = true;
                    render();
                    showStatus('‚úÖ Logo geladen!');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleAudioUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            audioElement.src = url;

            if (audioSource) {
                audioSource.disconnect();
            }

            audioSource = audioContext.createMediaElementSource(audioElement);
            audioSource.connect(analyser);
            analyser.connect(audioContext.destination);

            audioElement.addEventListener('timeupdate', updateTime);
            audioElement.addEventListener('loadedmetadata', updateTime);

            showStatus('‚úÖ Audio geladen!');
        }

        function updateTime() {
            const current = formatTime(audioElement.currentTime);
            const duration = formatTime(audioElement.duration || 0);
            document.getElementById('audioTime').textContent = `${current} / ${duration}`;
        }

        // Render function
        function render() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Get audio data if reactive
            let bassLevel = 0;
            if (state.enableReactive && isPlaying) {
                analyser.getByteFrequencyData(dataArray);
                const bass = dataArray.slice(0, 10);
                bassLevel = bass.reduce((a, b) => a + b, 0) / bass.length / 255;
            }

            // Draw background
            if (state.backgroundImage) {
                ctx.save();
                
                // Apply filters
                let filterString = '';
                if (state.bgBrightness !== 100) {
                    filterString += `brightness(${state.bgBrightness}%)`;
                }
                if (state.bgBlur > 0) {
                    filterString += ` blur(${state.bgBlur}px)`;
                }
                if (filterString) {
                    ctx.filter = filterString;
                }

                // Calculate scale and position
                const scale = state.bgScale / 100;
                const imgWidth = state.backgroundImage.width;
                const imgHeight = state.backgroundImage.height;
                const canvasRatio = canvas.width / canvas.height;
                const imgRatio = imgWidth / imgHeight;

                let drawWidth, drawHeight;
                if (imgRatio > canvasRatio) {
                    drawHeight = canvas.height * scale;
                    drawWidth = drawHeight * imgRatio;
                } else {
                    drawWidth = canvas.width * scale;
                    drawHeight = drawWidth / imgRatio;
                }

                const offsetX = (canvas.width - drawWidth) * (state.bgPosX / 100);
                const offsetY = (canvas.height - drawHeight) * (state.bgPosY / 100);

                ctx.drawImage(state.backgroundImage, offsetX, offsetY, drawWidth, drawHeight);
                
                ctx.filter = 'none';
                ctx.restore();

                // Overlay
                if (state.bgOverlay > 0) {
                    ctx.fillStyle = `rgba(0, 0, 0, ${state.bgOverlay / 100})`;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            } else {
                // Default gradient background
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#1a1a1a');
                gradient.addColorStop(1, '#0a0a0a');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // Draw Text 1 with animation
            drawText(
                state.text1,
                state.font1,
                state.fontSize1,
                state.textColor1,
                state.textPosY1,
                state.letterSpacing1,
                state.stroke1,
                state.strokeColor1,
                state.opacity1,
                state.rotation1,
                bassLevel
            );

            // Draw Text 2 with animation
            drawText(
                state.text2,
                state.font2,
                state.fontSize2,
                state.textColor2,
                state.textPosY2,
                state.letterSpacing2,
                state.stroke2,
                state.strokeColor2,
                state.opacity2,
                state.rotation2,
                bassLevel
            );

            // Draw Badge (NO animation)
            if (state.showBadge && state.badge) {
                drawBadge(0); // Pass 0 to disable animation
            }

            // Draw Logo (NO animation)
            if (state.showLogo && state.logoImage) {
                drawLogo();
            }

            // Draw Info (NO animation)
            drawInfo();

            // Continue animation
            if (state.enableReactive && isPlaying) {
                animationId = requestAnimationFrame(render);
            }
        }

        function drawText(text, font, size, color, posY, spacing, strokeWidth, strokeColor, opacity, rotation, bassLevel) {
            if (!text) return;

            ctx.save();
            
            // Apply reactive pulse
            const pulseSize = state.enableReactive && bassLevel > 0 
                ? size + (bassLevel * state.pulseStrength) 
                : size;

            ctx.font = `900 ${pulseSize}px "${font}"`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.globalAlpha = opacity / 100;

            // Apply rotation
            if (rotation !== 0) {
                ctx.translate(canvas.width / 2, posY);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.translate(-canvas.width / 2, -posY);
            }

            // Calculate total width with letter spacing
            const metrics = ctx.measureText(text);
            const totalSpacing = (text.length - 1) * spacing;
            const totalWidth = metrics.width + totalSpacing;
            let x = (canvas.width - totalWidth) / 2;

            // Draw each character
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const charMetrics = ctx.measureText(char);

                // Draw stroke (NO SHADOW!)
                if (strokeWidth > 0) {
                    ctx.strokeStyle = strokeColor;
                    ctx.lineWidth = strokeWidth;
                    ctx.lineJoin = 'round';
                    ctx.strokeText(char, x + charMetrics.width / 2, posY);
                }

                // Draw fill
                ctx.fillStyle = color;
                ctx.fillText(char, x + charMetrics.width / 2, posY);

                x += charMetrics.width + spacing;
            }

            ctx.restore();
        }

        function drawBadge(bassLevel) {
            ctx.save();

            const scale = state.badgeSize * (state.enableReactive && bassLevel > 0 ? 1 + bassLevel * 0.1 : 1);
            
            ctx.translate(state.badgePosX, state.badgePosY);
            ctx.rotate(state.badgeRot * Math.PI / 180);
            ctx.scale(scale, scale);

            // Badge background
            ctx.fillStyle = state.badgeColor;
            ctx.beginPath();
            ctx.roundRect(-60, -25, 120, 50, 8);
            ctx.fill();

            // Badge text
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(state.badge, 0, 0);

            ctx.restore();
        }

        function drawLogo() {
            if (!state.logoImage) return;

            ctx.save();
            ctx.globalAlpha = state.logoOpacity / 100;

            ctx.translate(state.logoPosX, state.logoPosY);
            ctx.rotate(state.logoRot * Math.PI / 180);

            const logoW = state.logoSize;
            const logoH = (state.logoImage.height / state.logoImage.width) * logoW;

            ctx.drawImage(state.logoImage, -logoW / 2, -logoH / 2, logoW, logoH);

            ctx.restore();
        }

        function drawInfo() {
            // BPM
            ctx.fillStyle = state.infoColor;
            ctx.font = `bold ${state.infoSize}px Arial`;
            ctx.textAlign = 'left';
            ctx.fillText(`${state.bpm} BPM`, 40, canvas.height - 40);

            // Info text
            ctx.textAlign = 'right';
            ctx.fillText(state.infoText, canvas.width - 40, canvas.height - 40);
        }

        // Audio controls
        async function toggleAudio() {
            if (!audioElement.src) {
                showStatus('‚ùå Bitte zuerst Audio hochladen!');
                return;
            }

            if (isPlaying) {
                audioElement.pause();
                isPlaying = false;
                document.getElementById('playBtn').textContent = '‚ñ∂';
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                render();
            } else {
                try {
                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                    await audioElement.play();
                    isPlaying = true;
                    document.getElementById('playBtn').textContent = '‚è∏';
                    if (state.enableReactive) {
                        render();
                    }
                } catch (error) {
                    console.error('Play error:', error);
                    showStatus('‚ùå Fehler beim Abspielen');
                    isPlaying = false;
                    document.getElementById('playBtn').textContent = '‚ñ∂';
                }
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Export functions
        function downloadImage() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            render();

            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `WIB_${state.text1}_${state.text2}_${Date.now()}.png`;
                a.click();
                URL.revokeObjectURL(url);

                showStatus('‚úÖ PNG gespeichert!');

                if (state.enableReactive && isPlaying) {
                    render();
                }
            });
        }

        let currentRecorder = null;
        let recordChunks = [];

        async function recordVideo() {
            if (!audioElement.src) {
                showStatus('‚ùå Bitte zuerst Audio hochladen!');
                return;
            }

            const recordBtn = document.getElementById('recordBtn');

            // If already recording, stop it
            if (currentRecorder && currentRecorder.state === 'recording') {
                currentRecorder.stop();
                audioElement.pause();
                isPlaying = false;
                document.getElementById('playBtn').textContent = '‚ñ∂';
                recordBtn.textContent = 'üé¨ Als Video exportieren';
                recordBtn.classList.remove('secondary');
                showStatus('‚è≥ Video wird finalisiert...');
                return;
            }

            try {
                // Setup streams
                const canvasStream = canvas.captureStream(60); // 60 FPS for smooth animation
                const audioDestination = audioContext.createMediaStreamDestination();
                audioSource.connect(audioDestination);

                const combinedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...audioDestination.stream.getAudioTracks()
                ]);

                // Setup recorder with high quality
                recordChunks = [];
                currentRecorder = new MediaRecorder(combinedStream, {
                    mimeType: 'video/webm;codecs=vp9,opus',
                    videoBitsPerSecond: 10000000 // 10 Mbps for high quality
                });

                currentRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordChunks.push(event.data);
                    }
                };

                currentRecorder.onstop = () => {
                    const blob = new Blob(recordChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `WIB_${state.text1}_${state.text2}_${Date.now()}.webm`;
                    a.click();
                    URL.revokeObjectURL(url);

                    recordBtn.disabled = false;
                    recordBtn.textContent = 'üé¨ Als Video exportieren';
                    recordBtn.classList.remove('secondary');
                    showStatus('‚úÖ Video exportiert! (WebM - mit VLC als MP4 speichern)');
                    currentRecorder = null;
                };

                // Start recording
                currentRecorder.start(100); // Capture in 100ms chunks

                // Start audio playback
                audioElement.currentTime = 0;
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                await audioElement.play();
                isPlaying = true;
                document.getElementById('playBtn').textContent = '‚è∏';

                // Enable animation
                state.enableReactive = true;
                document.getElementById('enableReactive').checked = true;
                render();

                // Update button
                recordBtn.textContent = '‚èπ Export stoppen';
                recordBtn.classList.add('secondary');
                showStatus('üî¥ Video wird aufgenommen - l√§uft in Echtzeit!');

                // Auto-stop when audio ends
                audioElement.onended = () => {
                    if (currentRecorder && currentRecorder.state === 'recording') {
                        currentRecorder.stop();
                        isPlaying = false;
                        document.getElementById('playBtn').textContent = '‚ñ∂';
                    }
                };

            } catch (error) {
                console.error('Export error:', error);
                showStatus('‚ùå Fehler: ' + error.message);
                recordBtn.disabled = false;
                recordBtn.textContent = 'üé¨ Als Video exportieren';
                currentRecorder = null;
            }
        }

        function showStatus(message) {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.textContent = message;
            statusMsg.style.display = 'block';
            setTimeout(() => {
                statusMsg.style.display = 'none';
            }, 4000);
        }

        // Presets
        const presets = {
            drill: {
                text1: 'DRILL',
                text2: 'BALKAN',
                textColor1: '#ffffff',
                textColor2: '#ffffff',
                badge: 'FREE',
                badgeColor: '#ff0844',
                bpm: 140
            },
            trap: {
                text1: 'TRAP',
                text2: 'BEAT',
                textColor1: '#ffffff',
                textColor2: '#9d00ff',
                badge: 'FREE',
                badgeColor: '#9d00ff',
                bpm: 145
            },
            melodic: {
                text1: 'MELODIC',
                text2: 'VIBES',
                textColor1: '#00d4ff',
                textColor2: '#7b2cbf',
                badge: 'FREE',
                badgeColor: '#00d4ff',
                bpm: 130
            },
            aggressive: {
                text1: 'HARD',
                text2: 'BEAT',
                textColor1: '#ffffff',
                textColor2: '#ff0000',
                badge: 'NEW',
                badgeColor: '#ff0000',
                bpm: 150
            },
            balkan: {
                text1: 'DRILL',
                text2: 'BALKAN',
                textColor1: '#ffffff',
                textColor2: '#0066ff',
                badge: 'FREE',
                badgeColor: '#ff0000',
                bpm: 140
            },
            dark: {
                text1: 'DARK',
                text2: 'BEAT',
                textColor1: '#ffffff',
                textColor2: '#999999',
                badge: 'NEW',
                badgeColor: '#4a4a4a',
                bpm: 135
            }
        };

        function applyPreset(name) {
            const preset = presets[name];

            document.getElementById('text1').value = preset.text1;
            document.getElementById('text2').value = preset.text2;
            document.getElementById('textColor1').value = preset.textColor1;
            document.getElementById('textColor2').value = preset.textColor2;
            document.getElementById('badge').value = preset.badge;
            document.getElementById('badgeColor').value = preset.badgeColor;
            document.getElementById('bpm').value = preset.bpm;

            state.text1 = preset.text1;
            state.text2 = preset.text2;
            state.textColor1 = preset.textColor1;
            state.textColor2 = preset.textColor2;
            state.badge = preset.badge;
            state.badgeColor = preset.badgeColor;
            state.bpm = preset.bpm;

            render();
            showStatus(`‚úÖ Vorlage "${name}" angewendet!`);
        }

        // Initial render
        render();
    </script>
</body>
</html>
